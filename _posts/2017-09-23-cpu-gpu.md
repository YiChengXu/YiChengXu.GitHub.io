---
layout: post
title: 优化思路GPU和CPU
date: 2017-09-23
categories: blog
tags: [图像优化]
description: 在这里我们简单来讲讲iOS图形优化的思路

---

* 1、概述
* 1、GPU
* 2、CPU

## 概述
从计算机的角度来说，绘图都是只有两种方式，一种是CPU绘制一种是GPU绘制。总体来说，GPU绘制更为良好，毕竟从GPU的硬件设计来说，天生就对图像进行了大量的优化。但是如果GPU的负载已经很高了呢？那么性能就会以几何倍的下降了。这篇文章我们就来讲讲GPU和CPU会降低性能的一些问题吧。

## GPU
### 1.几何结构的变换
当然这个问题，严格意义上应该归结于CPU的问题，现在的iOS设备可以处理百万级别的三角形(CPU传输给GPU三维形状数据到了GPU中GPU会根据三个顶点自动连接成一个三角面)因此单纯的几何结构应该不构成应用的瓶颈。但是真正的问题在于，如此多的三角形在送至GPU之前，需要CPU对图层进行计算大量的图层最终就会变成一个超重量级的对象了对CPU是一种负担。

### 2.重绘
这个问题往往是由于开发者在应用中大量使用重叠的半透明的图层导致的。由于GPU的填充比率是有限的，所以我们尽量避免重绘。虽然重实际角度来说这个问题会非常的不明显。特别是opaque属性default is YES。

### 3.离屏绘制
这发生在当不能直接在屏幕上绘制，并且必须绘制到离屏图片的上下文中的时候。离屏绘制发生在基于CPU或者是GPU的渲染，或者是为离屏图片分配额外内存，以及切换绘制上下文，这些都会降低GPU性能。典型的会触发离屏渲染的地方是圆角，mask，阴影或者光栅化。但是离屏渲染不一定只会带来坏处，有时候会带来一些好处，这个我们后面再说。

### 4.超大的图片
iPhone最大支持的渲染纹理为2048\*2048或者是4096\*4096(这个根据设备的不同而有所不同)，当图片的大小超过这个时，CPU必须对图片进行处理，GPU才能使用，这同样会消耗性能。

## CPU
### 1.布局
视图结构的布局的计算是需要消耗CPU资源的。特别是你使用自动布局的时候，消耗的CPU资源会更加高。

### 2.视图懒加载
iOS的视图只有在真正显示在屏幕上时才会真正的加载资源。这有个比较不好的效果就是，倘若你push的界面内容过于复杂，那么你会发现push按钮点击后手机卡顿了一下才会跳转，这样的用户体验是非常不理想的(后期会补上视图跳转时的优化)。还有种比较缓慢的情况就是你使用了Xib和Storyboard，这个首先要消耗IO资源，然后系统要对xml的文档结构进行解析，最后在布局显示。也就是为什么xib和storyboard写的界面性能会比普通的界面低的原因了。

### 3.Core Graphics
一个视图如果实现了drawRect方法，或者实现了CALayerDelegate的drawLayer:inContext:方法那么会在你绘制之前就有大量的开销了。为了支持对图层内容的任意绘制，Core Animation必须创建一个内存中等大小的寄宿图片。然后一旦绘制结束之后，必须把图片数据通过IPC传到渲染服务器。在此基础上，Core Graphics绘制就会变得十分缓慢，所以在一个对性能十分挑剔的场景下这样做十分不好。

### 4.解压图片
PNG和JPEG的图片会比位图小非常多。但是同样的，GPU是不能直接绘制JPG和PNG的图片，必须使用CPU对图片进行解压。同样的类似于懒加载iOS也只有在真正需要绘制的时候才会解压图片(不等于绘制到屏幕上)。


